<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شات دارك ويب — نسخة محسنة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- نفس تصميم النسخة الأصلية مع تحسينات بسيطة --- */
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color:#0a0a0a; min-height:100vh; color:#e0e0e0; background-image:url('https://i.imgur.com/JF9gUPa.png'); background-size:cover; background-position:center; }
        .container{ max-width:1200px; margin:0 auto; padding:20px; display:flex; flex-direction:column; gap:18px; }
        header{ background-color:rgba(20,20,20,0.9); padding:12px; border-radius:8px; text-align:center; }
        header h1{ color:#bb86fc; }
        .login-container, .register-container, .chat-container{ background-color:rgba(20,20,20,0.8); padding:20px; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.8); border:1px solid #333; }
        .login-form, .register-form{ max-width:420px; margin:0 auto; }
        .form-group{ margin-bottom:16px; position:relative; }
        .form-group label{ display:block; margin-bottom:6px; color:#bb86fc; }
        .form-group input{ width:100%; padding:12px 14px 12px 40px; border-radius:8px; background:#1a1a1a; color:#e0e0e0; border:1px solid #444; }
        .form-group i{ position:absolute; left:12px; top:36px; color:#bb86fc; }
        .btn{ background:#bb86fc; color:#121212; padding:12px; border-radius:8px; border:none; width:100%; font-weight:700; cursor:pointer; }
        .btn:hover{ transform:translateY(-2px); }
        .error-message{ background:rgba(207,102,121,0.12); color:#cf6679; padding:10px; border-radius:8px; display:none; }
        .success-message{ background:rgba(3,218,198,0.12); color:#03dac6; padding:10px; border-radius:8px; display:none; }

        /* chat */
        .chat-header{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
        .chat-messages{ max-height:420px; overflow:auto; padding:16px; background:rgba(10,10,10,0.7); border-radius:8px; }
        .message{ margin-bottom:14px; max-width:80%; display:flex; flex-direction:column; animation:messageIn .25s ease; }
        .message.sent{ align-self:flex-start; }
        .message.received{ align-self:flex-end; }
        .message .message-content{ padding:12px 16px; border-radius:14px; word-break:break-word; }
        .message.sent .message-content{ background:#bb86fc; color:#121212; }
        .message.received .message-content{ background:#2d2d2d; color:#e0e0e0; }
        .message-info{ font-size:12px; color:#aaa; margin-top:6px; display:flex; gap:8px; align-items:center; }
        .message-actions{ display:flex; gap:8px; margin-top:6px; }
        .message-action-btn{ background:none; border:none; color:#888; cursor:pointer; }

        .chat-input-container{ display:flex; gap:8px; margin-top:12px; align-items:center; }
        .chat-input{ flex:1; padding:12px 14px; border-radius:20px; background:#1a1a1a; color:#e0e0e0; border:1px solid #444; }
        .send-btn{ width:46px; height:46px; border-radius:50%; border:none; background:#bb86fc; color:#121212; cursor:pointer; }

        .status-indicator{ padding:8px 12px; border-radius:8px; background:rgba(3,218,198,0.08); color:#03dac6; display:flex; gap:8px; align-items:center; }
        .online-users{ max-height:100px; overflow:auto; padding:8px; border-radius:8px; background:rgba(20,20,20,0.7); }
        .typing-indicator{ font-style:italic; color:#aaa; display:none; }

        @keyframes messageIn{ from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:none;} }

        /* small screens */
        @media (max-width:600px){ .container{ padding:12px } .chat-messages{ max-height:300px } }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>شات دارك ويب — نسخة محسنة</h1></header>

        <div class="login-container" id="loginContainer">
            <div class="login-form">
                <h2>تسجيل الدخول</h2>
                <div class="error-message" id="loginError"></div>
                <div class="form-group">
                    <label for="username">اسم المستخدم</label>
                    <i class="fas fa-user"></i>
                    <input type="text" id="username" placeholder="أدخل اسم المستخدم" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">كلمة المرور</label>
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" placeholder="أدخل كلمة المرور" autocomplete="current-password">
                </div>
                <button class="btn" id="loginBtn">تسجيل الدخول</button>
                <p style="text-align:center; margin-top:10px;">ليس لديك حساب؟ <a href="#" id="showRegisterBtn">إنشاء حساب جديد</a></p>
            </div>
        </div>

        <div class="register-container" id="registerContainer" style="display:none;">
            <div class="register-form">
                <h2>إنشاء حساب جديد</h2>
                <div class="error-message" id="registerError"></div>
                <div class="success-message" id="registerSuccess"></div>
                <div class="form-group">
                    <label for="newUsername">اسم المستخدم</label>
                    <i class="fas fa-user-plus"></i>
                    <input type="text" id="newUsername" placeholder="أدخل اسم المستخدم" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="newPassword">كلمة المرور</label>
                    <i class="fas fa-lock"></i>
                    <input type="password" id="newPassword" placeholder="أدخل كلمة المرور" autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">تأكيد كلمة المرور</label>
                    <i class="fas fa-check-circle"></i>
                    <input type="password" id="confirmPassword" placeholder="أعد إدخال كلمة المرور">
                </div>
                <button class="btn" id="registerBtn">إنشاء حساب</button>
                <p style="text-align:center; margin-top:10px;">لديك حساب بالفعل؟ <a href="#" id="showLoginBtn">تسجيل الدخول</a></p>
            </div>
        </div>

        <div class="chat-container" id="chatContainer" style="display:none;">
            <div class="chat-header">
                <h2><i class="fas fa-comment-alt"></i> شات دارك ويب</h2>
                <div style="display:flex; gap:12px; align-items:center;">
                    <div id="currentUser" style="color:#03dac6; font-weight:bold;"></div>
                    <button class="btn" id="logoutBtn" style="background:#cf6679; color:#121212; padding:8px 10px; width:auto;">تسجيل الخروج</button>
                </div>
            </div>

            <div class="status-indicator" id="statusIndicator"> <i class="fas fa-sync-alt"></i> جاري التزامن...</div>

            <div style="display:flex; gap:12px; margin-top:12px;">
                <div style="flex:1;">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-container">
                        <input type="text" id="messageInput" class="chat-input" placeholder="اكتب رسالتك هنا..." autocomplete="off">
                        <button class="send-btn" id="sendBtn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                    <div class="typing-indicator" id="typingIndicator">يكتب الآن...</div>
                </div>
                <div style="width:260px;">
                    <div class="online-users" id="onlineUsers">
                        <div style="color:#bb86fc; font-weight:bold; margin-bottom:8px;"> <i class="fas fa-circle"></i> المستخدمون المتصلون (<span id="onlineCount">0</span>)</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
    /*
        نسخة محسنة من الشات:
        - لا نحفظ كلمات المرور بنص واضح: نحفظ هاش SHA-256 في localStorage
        - مزامنة بين تبويبات نفس المتصفح باستخدام BroadcastChannel (الرسائل، قائمة المتصلين، مؤشر الكتابة)
        - تحسين منع XSS عن طريق استخدام textContent وتهيئة رسائل النظام بعناية
        - إصلاح بعض الأخطاء الطفيفة (تكرار المستخدم، متغيرات غير مستخدمة)
        - جعل حذف الرسائل القديمة قابل للتهيئة (افتراضي 120 ثانية كما كان)
    */

    // ---------- إعدادات ----------
    const STORAGE_USERS = 'darkwebUsers_v2';
    const STORAGE_MESSAGES = 'darkwebMessages_v2';
    const STORAGE_ONLINE = 'darkwebOnlineUsers_v2';
    const STORAGE_MESSAGE_FILE = 'darkwebMessageFile_v2';

    // حذف الرسائل الأقدم من (ms) — افتراضي 120000 ms = 120 ثانية
    const MAX_MESSAGE_AGE_MS = 120000; // يمكن تغييره

    // عناصر DOM
    const loginContainer = document.getElementById('loginContainer');
    const registerContainer = document.getElementById('registerContainer');
    const chatContainer = document.getElementById('chatContainer');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const showRegisterBtn = document.getElementById('showRegisterBtn');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const sendBtn = document.getElementById('sendBtn');
    const messageInput = document.getElementById('messageInput');
    const chatMessages = document.getElementById('chatMessages');
    const currentUserElement = document.getElementById('currentUser');
    const loginError = document.getElementById('loginError');
    const registerError = document.getElementById('registerError');
    const registerSuccess = document.getElementById('registerSuccess');
    const statusIndicator = document.getElementById('statusIndicator');
    const onlineUsersContainer = document.getElementById('onlineUsers');
    const typingIndicator = document.getElementById('typingIndicator');
    const onlineCount = document.getElementById('onlineCount');

    // البيانات المحلية
    let users = JSON.parse(localStorage.getItem(STORAGE_USERS) || '[]');
    let messages = JSON.parse(localStorage.getItem(STORAGE_MESSAGES) || '[]');
    let messageFile = JSON.parse(localStorage.getItem(STORAGE_MESSAGE_FILE) || '[]');
    let onlineUsers = JSON.parse(localStorage.getItem(STORAGE_ONLINE) || '[]');
    let currentUser = null;
    let isTyping = false;
    let typingTimeout = null;

    // BroadcastChannel للمزامنة بين تبويبات المتصفح
    let bc;
    try { bc = new BroadcastChannel('darkweb_channel_v2'); } catch (e) { bc = null; }

    function broadcast(action, payload){
        if (!bc) return;
        bc.postMessage({ action, payload });
    }

    if (bc) {
        bc.onmessage = (ev) => {
            const { action, payload } = ev.data || {};
            if (!action) return;
            switch(action){
                case 'new-message':
                    // تجنب إضافة مكرر
                    if (!messages.some(m => m.id === payload.id)){
                        messages.push(payload);
                        localStorage.setItem(STORAGE_MESSAGES, JSON.stringify(messages));
                        addMessageToChat(payload);
                        scrollChatToBottom();
                    }
                    break;
                case 'user-joined':
                    addUserToOnlineLocal(payload.username, false);
                    break;
                case 'user-left':
                    removeUserFromOnlineLocal(payload.username, false);
                    break;
                case 'typing':
                    showTypingIndicator(payload.username, payload.isTyping);
                    break;
                case 'sync-request':
                    // أحد التبويبات يطلب مزامنة: نرسل بياناتنا الحالية
                    bc.postMessage({ action:'sync-response', payload: { messages, onlineUsers } });
                    break;
                case 'sync-response':
                    // ادمج البيانات المستلمة
                    mergeMessages(payload.messages || []);
                    mergeOnline(payload.onlineUsers || []);
                    break;
            }
        };
    }

    // عند بدء تشغيل تبويب جديد نطلب مزامنة
    if (bc) broadcast('sync-request', {});

    // ---------- وظائف مساعدة ----------
    function saveAll(){
        localStorage.setItem(STORAGE_USERS, JSON.stringify(users));
        localStorage.setItem(STORAGE_MESSAGES, JSON.stringify(messages));
        localStorage.setItem(STORAGE_MESSAGE_FILE, JSON.stringify(messageFile));
        localStorage.setItem(STORAGE_ONLINE, JSON.stringify(onlineUsers));
    }

    function escapeHTML(str){
        // بسيطة وآمنة بما يكفي لرسائل الدردشة (نستخدم textContent غالبًا)
        const p = document.createElement('div');
        p.textContent = str;
        return p.innerHTML;
    }

    function scrollChatToBottom(){ chatMessages.scrollTop = chatMessages.scrollHeight; }

    function formatTime(ts){ const d = new Date(ts); return d.toLocaleTimeString(); }

    // --------- تجزئة كلمة المرور (SHA-256) ---------
    async function hashPassword(password){
        const enc = new TextEncoder();
        const data = enc.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // ---------- إدارة المستخدمين المتصلين (محلي + بث) ----------
    function addUserToOnlineLocal(username, broadcastFlag=true){
        if (!username) return;
        if (!onlineUsers.includes(username)){
            onlineUsers.push(username);
            saveAll();
            updateOnlineUsersList();
            if (broadcastFlag) broadcast('user-joined', { username });
        }
    }

    function removeUserFromOnlineLocal(username, broadcastFlag=true){
        onlineUsers = onlineUsers.filter(u => u !== username);
        saveAll();
        updateOnlineUsersList();
        if (broadcastFlag) broadcast('user-left', { username });
    }

    function updateOnlineUsersList(){
        // مسح القديم
        while (onlineUsersContainer.childNodes.length > 1) onlineUsersContainer.removeChild(onlineUsersContainer.lastChild);
        // إضافة
        onlineUsers.forEach(user => {
            const div = document.createElement('div');
            div.style.padding = '6px 8px';
            div.style.marginBottom = '6px';
            div.style.borderRadius = '6px';
            div.style.background = 'rgba(45,45,45,0.6)';
            div.style.color = '#03dac6';
            div.textContent = `${user}${user === currentUser ? ' (أنت)' : ''}`;
            onlineUsersContainer.appendChild(div);
        });
        onlineCount.textContent = onlineUsers.length;
    }

    // ---------- إضافة رسالة للشات (مع حماية XSS) ----------
    function addMessageToChat(message){
        // منع إضافة مكرر
        if (document.querySelector(`.message[data-id='${message.id}']`)) return;

        const el = document.createElement('div');
        el.classList.add('message');
        el.dataset.id = message.id;

        if (message.isSystem){
            el.style.alignSelf = 'center';
            const content = document.createElement('div');
            content.style.backgroundColor = 'rgba(187,134,252,0.12)';
            content.style.color = '#bb86fc';
            content.style.padding = '8px 12px';
            content.style.borderRadius = '12px';
            content.style.textAlign = 'center';
            // امن: نستخدم textContent
            content.textContent = message.content;
            el.appendChild(content);
        } else {
            el.classList.add(message.sender === currentUser ? 'sent' : 'received');
            const content = document.createElement('div');
            content.classList.add('message-content');
            content.textContent = message.content; // آمن

            const info = document.createElement('div');
            info.classList.add('message-info');
            info.textContent = `${message.sender} • ${formatTime(message.timestamp)}`;

            const actions = document.createElement('div');
            actions.classList.add('message-actions');

            if (message.sender === currentUser){
                const del = document.createElement('button');
                del.classList.add('message-action-btn');
                del.title = 'حذف الرسالة';
                del.innerHTML = '<i class="fas fa-trash-alt"></i>';
                del.onclick = () => deleteMessage(message.id);
                actions.appendChild(del);
            }

            const reply = document.createElement('button');
            reply.classList.add('message-action-btn');
            reply.title = 'رد';
            reply.innerHTML = '<i class="fas fa-reply"></i>';
            reply.onclick = () => replyToMessage(message);
            actions.appendChild(reply);

            el.appendChild(content);
            el.appendChild(info);
            el.appendChild(actions);
        }

        chatMessages.appendChild(el);
    }

    // ---------- إرسال رسالة ----------
    function sendMessage(){
        const content = messageInput.value.trim();
        if (!content || !currentUser) return;

        const msg = { id: Date.now().toString() + Math.random().toString(36).slice(2,6), sender: currentUser, content, timestamp: new Date().toISOString() };
        messages.push(msg);
        messageFile.push(msg);
        saveAll();
        addMessageToChat(msg);
        scrollChatToBottom();
        messageInput.value = '';

        // نذيع الرسالة للتبويبات الأخرى
        broadcast('new-message', msg);
    }

    // ---------- حذف رسالة ----------
    function deleteMessage(id){
        messageFile = messageFile.filter(m => m.id !== id);
        messages = messages.filter(m => m.id !== id);
        saveAll();
        const el = document.querySelector(`.message[data-id='${id}']`);
        if (el) el.remove();
        // إضافة رسالة نظام لإعلام الحذف
        const sys = { id: Date.now().toString(), sender: 'النظام', content: `تم حذف رسالة بواسطة ${currentUser}`, timestamp: new Date().toISOString(), isSystem:true };
        messageFile.push(sys); messages.push(sys); saveAll(); addMessageToChat(sys);
        broadcast('new-message', sys);
    }

    // ---------- الرد على رسالة ----------
    function replyToMessage(message){
        // نضع نص مختصر للرد في حقل الإدخال
        messageInput.value = `رد على ${message.sender}: ${message.content.substring(0,30)}... | `;
        messageInput.focus();
    }

    // ---------- تحميل الرسائل (من التخزين) ----------
    function loadMessages(){
        chatMessages.innerHTML = '';
        messages.forEach(m => addMessageToChat(m));
        scrollChatToBottom();
    }

    // دمج رسائل مستلمة من تبويب آخر
    function mergeMessages(remoteMsgs){
        let changed = false;
        remoteMsgs.forEach(r => { if (!messages.some(m=>m.id===r.id)){ messages.push(r); changed = true; } });
        if (changed) { saveAll(); loadMessages(); }
    }

    function mergeOnline(remoteOnline){
        const set = new Set([...onlineUsers, ...remoteOnline]);
        onlineUsers = Array.from(set);
        saveAll(); updateOnlineUsersList();
    }

    // ---------- تحميل من "messageFile" (يحاكي ملف الرسائل في النسخة القديمة) ----------
    function loadMessagesFromFile(){
        statusIndicator.textContent = `آخر تحديث: ${formatTime(new Date())}`;
        // إضافة أي رسائل جديدة موجودة في messageFile
        const newMsgs = messageFile.filter(f => !messages.some(m => m.id === f.id));
        if (newMsgs.length){
            messages = [...messages, ...newMsgs];
            saveAll();
            newMsgs.forEach(addMessageToChat);
            scrollChatToBottom();
        }
    }

    // ---------- حذف الرسائل القديمة ----------
    function deleteOldMessages(){
        const now = Date.now();
        const recent = messageFile.filter(m => (now - new Date(m.timestamp)) <= MAX_MESSAGE_AGE_MS);
        if (recent.length < messageFile.length){
            const sys = { id: Date.now().toString(), sender:'النظام', content:`تم حذف ${messageFile.length - recent.length} رسائل قديمة`, timestamp: new Date().toISOString(), isSystem:true };
            recent.push(sys);
            messageFile = recent; messages = recent.slice(); saveAll(); loadMessages(); broadcast('new-message', sys);
        }
    }

    // ---------- مؤشر الكتابة (يُبث للتبويبات الأخرى) ----------
    function updateTypingStatus(is){
        if (!currentUser) return;
        if (is) showTypingIndicator(currentUser, true);
        else showTypingIndicator(currentUser, false);
        broadcast('typing', { username: currentUser, isTyping: is });
    }

    function showTypingIndicator(username, show){
        if (!show){ typingIndicator.style.display = 'none'; return; }
        typingIndicator.textContent = `${username} يكتب الآن...`;
        typingIndicator.style.display = 'block';
        setTimeout(()=>{ typingIndicator.style.display = 'none'; }, 2500);
    }

    // ---------- دمج عند بدء التشغيل ----------
    // إذا كان هناك مستخدم مسجل في localStorage من قبل
    if (localStorage.getItem('currentDarkwebUser_v2')){
        currentUser = localStorage.getItem('currentDarkwebUser_v2');
        currentUserElement.textContent = currentUser;
        loginContainer.style.display = 'none'; chatContainer.style.display = 'block';
        addUserToOnlineLocal(currentUser, true);
        loadMessages(); loadMessagesFromFile(); updateOnlineUsersList();
    }

    // ---------- أحداث واجهة المستخدم ----------
    showRegisterBtn.addEventListener('click', (e)=>{ e.preventDefault(); loginContainer.style.display='none'; registerContainer.style.display='block'; });
    showLoginBtn.addEventListener('click', (e)=>{ e.preventDefault(); registerContainer.style.display='none'; loginContainer.style.display='block'; });

    registerBtn.addEventListener('click', async ()=>{
        const newUsername = document.getElementById('newUsername').value.trim();
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        registerError.style.display='none'; registerSuccess.style.display='none';
        if (!newUsername || !newPassword || !confirmPassword){ registerError.textContent='يرجى ملء جميع الحقول'; registerError.style.display='block'; return; }
        if (newPassword !== confirmPassword){ registerError.textContent='كلمات المرور غير متطابقة'; registerError.style.display='block'; return; }
        if (users.some(u=>u.username===newUsername)){ registerError.textContent='اسم المستخدم موجود بالفعل'; registerError.style.display='block'; return; }
        const hashed = await hashPassword(newPassword);
        users.push({ username:newUsername, passwordHash:hashed });
        saveAll();
        registerSuccess.textContent='تم إنشاء الحساب بنجاح! يمكنك الآن تسجيل الدخول'; registerSuccess.style.display='block';
        document.getElementById('newUsername').value=''; document.getElementById('newPassword').value=''; document.getElementById('confirmPassword').value='';
        setTimeout(()=>{ registerContainer.style.display='none'; loginContainer.style.display='block'; registerSuccess.style.display='none'; }, 1500);
    });

    loginBtn.addEventListener('click', async ()=>{
        const username = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        loginError.style.display='none';
        if (!username || !password){ loginError.textContent='يرجى إدخال اسم المستخدم وكلمة المرور'; loginError.style.display='block'; return; }
        const hashed = await hashPassword(password);
        const user = users.find(u => u.username === username && u.passwordHash === hashed);
        if (user){
            currentUser = username;
            localStorage.setItem('currentDarkwebUser_v2', currentUser);
            currentUserElement.textContent = currentUser;
            loginContainer.style.display='none'; chatContainer.style.display='block';
            addUserToOnlineLocal(currentUser, true);
            loadMessages(); loadMessagesFromFile(); updateOnlineUsersList();
            // رسالة نظام
            const sys = { id: Date.now().toString(), sender:'النظام', content:`${currentUser} انضم إلى المحادثة`, timestamp: new Date().toISOString(), isSystem:true };
            messageFile.push(sys); messages.push(sys); saveAll(); addMessageToChat(sys); broadcast('new-message', sys);
        } else {
            loginError.textContent='اسم المستخدم أو كلمة المرور غير صحيحة'; loginError.style.display='block';
        }
    });

    logoutBtn.addEventListener('click', ()=>{
        if (!currentUser) return;
        const sys = { id: Date.now().toString(), sender:'النظام', content:`${currentUser} غادر المحادثة`, timestamp: new Date().toISOString(), isSystem:true };
        messageFile.push(sys); messages.push(sys); saveAll(); addMessageToChat(sys); broadcast('new-message', sys);
        removeUserFromOnlineLocal(currentUser, true);
        localStorage.removeItem('currentDarkwebUser_v2'); currentUser=null;
        chatContainer.style.display='none'; loginContainer.style.display='block'; document.getElementById('username').value=''; document.getElementById('password').value='';
    });

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); sendMessage(); } });

    messageInput.addEventListener('input', ()=>{
        if (!isTyping && messageInput.value.trim() !== ''){ isTyping = true; updateTypingStatus(true); }
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(()=>{ isTyping=false; updateTypingStatus(false); }, 1500);
    });

    // التحديث الدوري — محليًا فقط (حافظنا على المنطق السابق لكن حسنَّاه)
    setInterval(()=>{ if (currentUser){ loadMessagesFromFile(); updateOnlineUsersList(); } }, 5000);
    setInterval(deleteOldMessages, 120000);

    // وظائف لمساعدة المزامنة
    function mergeInitialStorage(){
        users = JSON.parse(localStorage.getItem(STORAGE_USERS) || '[]');
        messages = JSON.parse(localStorage.getItem(STORAGE_MESSAGES) || '[]');
        messageFile = JSON.parse(localStorage.getItem(STORAGE_MESSAGE_FILE) || '[]');
        onlineUsers = JSON.parse(localStorage.getItem(STORAGE_ONLINE) || '[]');
    }

    mergeInitialStorage();

    </script>
</body>
</html>
